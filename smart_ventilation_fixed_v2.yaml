blueprint:
  name: Smart Ventilation v2 (Sensor Triggered)
  description: AH-based ventilation with sensor triggers instead of polling
  domain: automation
  input:
    # Room Configuration
    room_name:
      name: Room Name
      selector:
        text:
    # Sensors - Indoor
    temp_inside:
      name: Indoor Temperature Sensor
      selector:
        entity:
          domain: sensor
          device_class: temperature
    rh_inside:
      name: Indoor Humidity Sensor
      selector:
        entity:
          domain: sensor
          device_class: humidity
    ah_diff_sensor:
      name: AH Difference Sensor
      description: "Template sensor showing AH difference (room - outside)"
      selector:
        entity:
          domain: sensor
    # Window Sensors
    window_sensors:
      name: Window/Door Sensors
      description: "Select all windows and doors for this room"
      selector:
        entity:
          domain: binary_sensor
          device_class: opening
          multiple: true
    # Thresholds (Shared Helpers)
    ah_threshold_helper:
      name: AH Difference Threshold Helper
      description: "Shared across all rooms (e.g., input_number.prog_roznicy_ah_do_wentylacji)"
      selector:
        entity:
          domain: input_number
    rh_limit_helper:
      name: Humidity Threshold Helper
      description: "Shared across all rooms (e.g., input_number.prog_wilgotnosci_do_wentylacji)"
      selector:
        entity:
          domain: input_number
    # Notification Settings
    notify_services:
      name: Notify Services (one per line)
      description: "Enter notify services, one per line (e.g., notify.mobile_app_telefon_janka)"
      default: "notify.mobile_app_telefon_janka"
      selector:
        text:
          multiline: true
    frequency_cooldown:
      name: Notification Cooldown (Hours)
      description: "Minimum time between open-window notifications"
      default: 4
      selector:
        number:
          min: 1
          max: 24
          unit_of_measurement: "h"
    # Notification Messages
    notification_open_title:
      name: Open Window Notification Title
      description: "Title for ventilation needed notification"
      default: "ðŸŒ¬ï¸ Ventilation: {room}"
      selector:
        text:
    notification_open_message:
      name: Open Window Notification Message
      description: "Message for ventilation needed. Available variables: {room}, {humidity}, {ah_diff}"
      default: "Humidity: {humidity}%. AH difference: {ah_diff} g/mÂ³. Open a window!"
      selector:
        text:
          multiline: true
    notification_close_title:
      name: Close Window Notification Title
      description: "Title for close window notification"
      default: "ðŸšª Close window: {room}"
      selector:
        text:
    notification_close_message:
      name: Close Window Notification Message
      description: "Message for close window. Available variables: {room}, {ah_diff}"
      default: "AH difference has dropped to {ah_diff} g/mÂ³. Close the window."
      selector:
        text:
          multiline: true
    # Quiet Hours (Shared Helpers)
    quiet_hours_start:
      name: Quiet Hours Start Helper
      description: >
        Shared across all rooms. Must be an input_datetime configured
        as time-only (e.g., input_datetime.wentylacja_cisza_start)
      selector:
        entity:
          domain: input_datetime
    quiet_hours_end:
      name: Quiet Hours End Helper
      description: >
        Shared across all rooms. Must be an input_datetime configured
        as time-only (e.g., input_datetime.wentylacja_cisza_koniec)
      selector:
        entity:
          domain: input_datetime
    # Tracking Helpers
    last_notified_input:
      name: Last Open-Window Notification Time Helper
      description: "Unique per room - tracks when last open-window notification was sent"
      selector:
        entity:
          domain: input_datetime
    last_close_notified_input:
      name: Last Close-Window Notification Time Helper
      description: "Unique per room - tracks when last close-window notification was sent"
      selector:
        entity:
          domain: input_datetime

# ---------------------------------------------------------------------------
# TRIGGERS
# FIX 1: Removed the broken template-based ah_low trigger. The close-window
#         condition is now evaluated in the action's choose block whenever
#         the AH sensor or window sensors change state â€” no separate trigger needed.
# FIX 2: ah_high now uses !input ah_threshold_helper instead of a hardcoded
#         entity name, preserving the shared-helper design.
# FIX 3: Removed the humidity_changed trigger â€” it fired constantly but matched
#         no choose branch, wasting runs and risking swallowing real triggers
#         under mode: single.
# ---------------------------------------------------------------------------
trigger:
  - platform: numeric_state
    entity_id: !input ah_diff_sensor
    above: !input ah_threshold_helper
    id: "ah_high"

  - platform: numeric_state
    entity_id: !input ah_diff_sensor
    # Fires when AH diff drops to or below half the threshold.
    # We can't use !input here directly in 'below', so we trigger on any
    # downward crossing of a safe low value and let the action filter precisely.
    # The choose condition does the exact (ah_limit / 2) check.
    below: !input ah_threshold_helper
    id: "ah_low"

  - platform: state
    entity_id: !input window_sensors
    to: "on"
    id: "window_opened"

  - platform: state
    entity_id: !input window_sensors
    to: "off"
    id: "window_closed"

# ---------------------------------------------------------------------------
# CONDITION
# FIX 4: Replaced the broken variable reference with a direct !input call
#         so the availability check actually works at evaluation time.
# ---------------------------------------------------------------------------
condition:
  - condition: template
    value_template: >
      {{ states('!input ah_diff_sensor') not in ['unknown', 'unavailable'] }}

action:
  # --- Variable block 1: static config ---
  - variables:
      input_ah_diff: !input ah_diff_sensor
      rh_in_entity: !input rh_inside
      windows: !input window_sensors
      room: !input room_name
      ah_threshold_entity: !input ah_threshold_helper
      rh_threshold_entity: !input rh_limit_helper
      notify_list: !input notify_services
      cooldown: !input frequency_cooldown
      quiet_start_entity: !input quiet_hours_start
      quiet_end_entity: !input quiet_hours_end
      last_notified_entity: !input last_notified_input
      last_close_notified_entity: !input last_close_notified_input
      tag_id: "{{ 'vent_' ~ room | lower | replace(' ', '_') }}"
      msg_open_title: !input notification_open_title
      msg_open_body: !input notification_open_message
      msg_close_title: !input notification_close_title
      msg_close_body: !input notification_close_message

  # --- Variable block 2: derived values (depend on block 1) ---
  - variables:
      rh_in: "{{ states(rh_in_entity) | float(0) }}"
      ah_limit: "{{ states(ah_threshold_entity) | float(3) }}"
      rh_target: "{{ states(rh_threshold_entity) | float(50) }}"
      delta_af: "{{ states(input_ah_diff) | float(0) }}"
      any_window_open: >
        {{ expand(windows) | selectattr('state', 'eq', 'on') | list | count > 0 }}
      notify_targets: >
        {{ notify_list.split('\n') | map('trim') | select() | list }}
      hours_since_notify: >
        {% set last = states(last_notified_entity) %}
        {% if last in ['unknown', 'unavailable', 'none'] %}
          999
        {% else %}
          {{ ((as_timestamp(now()) - as_timestamp(last)) / 3600) | float(999) }}
        {% endif %}
      hours_since_close_notify: >
        {% set last = states(last_close_notified_entity) %}
        {% if last in ['unknown', 'unavailable', 'none'] %}
          999
        {% else %}
          {{ ((as_timestamp(now()) - as_timestamp(last)) / 3600) | float(999) }}
        {% endif %}
      # FIX 5: Quiet hours now extract HH:MM:SS safely from time-only
      #         input_datetime helpers regardless of formatting.
      in_quiet_hours: >
        {% set current = now().strftime('%H:%M:%S') %}
        {% set qs = state_attr(quiet_start_entity, 'timestamp') %}
        {% set qe = state_attr(quiet_end_entity, 'timestamp') %}
        {% if qs is none or qe is none %}
          false
        {% else %}
          {% set start = '%02d:%02d:%02d' | format(
              (qs // 3600) | int, ((qs % 3600) // 60) | int, (qs % 60) | int) %}
          {% set end = '%02d:%02d:%02d' | format(
              (qe // 3600) | int, ((qe % 3600) // 60) | int, (qe % 60) | int) %}
          {% if start < end %}
            {{ current >= start and current < end }}
          {% else %}
            {{ current >= start or current < end }}
          {% endif %}
        {% endif %}

  - choose:
      # OPTION 1: Window just opened â†’ clear the open-window notification
      - conditions:
          - condition: trigger
            id: "window_opened"
        sequence:
          - repeat:
              for_each: "{{ notify_targets }}"
              sequence:
                - service: "{{ repeat.item }}"
                  data:
                    message: "clear_notification"
                    data:
                      tag: "{{ tag_id }}"

      # OPTION 2: Ventilation needed â†’ send open-window notification
      - conditions:
          - condition: trigger
            id: "ah_high"
          - condition: template
            value_template: "{{ delta_af > ah_limit }}"
          - condition: template
            value_template: "{{ rh_in > rh_target }}"
          - condition: template
            value_template: "{{ not in_quiet_hours }}"
          - condition: template
            value_template: "{{ not any_window_open }}"
          - condition: template
            value_template: "{{ hours_since_notify > cooldown }}"
        sequence:
          - service: input_datetime.set_datetime
            target:
              entity_id: !input last_notified_input
            data:
              datetime: "{{ now().isoformat() }}"
          - repeat:
              for_each: "{{ notify_targets }}"
              sequence:
                - service: "{{ repeat.item }}"
                  data:
                    title: >
                      {{ msg_open_title.replace('{room}', room) }}
                    message: >
                      {{ msg_open_body
                         .replace('{room}', room)
                         .replace('{humidity}', rh_in | round(0) | string)
                         .replace('{ah_diff}', delta_af | round(1) | string) }}
                    data:
                      tag: "{{ tag_id }}"
                      priority: high
                      ttl: 0

      # OPTION 3: AH dropped enough â†’ send close-window notification
      # FIX 6: Added cooldown for close notifications to prevent spam when
      #         AH diff hovers near the half-threshold boundary.
      - conditions:
          - condition: trigger
            id: "ah_low"
          - condition: template
            value_template: "{{ delta_af <= (ah_limit / 2) }}"
          - condition: template
            value_template: "{{ any_window_open }}"
          - condition: template
            value_template: "{{ hours_since_close_notify > cooldown }}"
        sequence:
          - service: input_datetime.set_datetime
            target:
              entity_id: !input last_close_notified_input
            data:
              datetime: "{{ now().isoformat() }}"
          - repeat:
              for_each: "{{ notify_targets }}"
              sequence:
                - service: "{{ repeat.item }}"
                  data:
                    title: >
                      {{ msg_close_title.replace('{room}', room) }}
                    message: >
                      {{ msg_close_body
                         .replace('{room}', room)
                         .replace('{ah_diff}', delta_af | round(1) | string) }}
                    data:
                      tag: "{{ tag_id }}"
                      priority: high
                      ttl: 0

      # OPTION 4: Window closed and AH is still high â†’ re-send open notification
      #           (user closed it manually; remind them it still needs ventilating)
      - conditions:
          - condition: trigger
            id: "window_closed"
          - condition: template
            value_template: "{{ delta_af > ah_limit }}"
          - condition: template
            value_template: "{{ rh_in > rh_target }}"
          - condition: template
            value_template: "{{ not in_quiet_hours }}"
          - condition: template
            value_template: "{{ hours_since_notify > cooldown }}"
        sequence:
          - service: input_datetime.set_datetime
            target:
              entity_id: !input last_notified_input
            data:
              datetime: "{{ now().isoformat() }}"
          - repeat:
              for_each: "{{ notify_targets }}"
              sequence:
                - service: "{{ repeat.item }}"
                  data:
                    title: >
                      {{ msg_open_title.replace('{room}', room) }}
                    message: >
                      {{ msg_open_body
                         .replace('{room}', room)
                         .replace('{humidity}', rh_in | round(0) | string)
                         .replace('{ah_diff}', delta_af | round(1) | string) }}
                    data:
                      tag: "{{ tag_id }}"
                      priority: high
                      ttl: 0

# FIX 7: Changed from single to restart so that a real trigger (e.g. window
#         opened) is never silently dropped because a no-op run is in progress.
mode: restart
